#!/usr/bin/env bash
# file: /usr/local/bin/neomnia-next-install.sh
# purpose: Install Next.js under /opt/<project> with Node/Next menu, group=project (+add user), scaffold in /tmp, rights & logs NEOMNIA.
# fixes:
#  - Staging dir 100% lowercase to avoid npm error (no caps).
#  - Purge PREFIX/NPM_CONFIG_PREFIX for nvm compatibility.
#  - Fixed 'endac' -> 'esac'.
#  - CRITICAL FIX: Lowercase random suffix generation and project name normalization

set -euo pipefail

# ------------------ Log helpers ------------------
LOG_TAG="[ NEOMNIA ]"
banner() {
  local title="${1:-NEOMNIA ACSS}"
  echo "${LOG_TAG} ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓"
  printf "%s ┃ %-44s ┃\n" "${LOG_TAG}" "${title}"
  echo "${LOG_TAG} ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛"
}
log() { printf "%s %s\n" "${LOG_TAG}" "$*"; }

# Subprocess without PREFIX/NPM_CONFIG_PREFIX
run_cmd() {
  log "→ $*"
  set +e
  env -u PREFIX -u NPM_CONFIG_PREFIX bash -c "$*" 2>&1 | while IFS= read -r l; do printf "%s %s\n" "${LOG_TAG}" "$l"; done
  local s=${PIPESTATUS[0]}
  set -e
  return $s
}

on_error() { banner "ÉCHEC • NEOMNIA ACSS"; log "Une erreur est survenue. Voir les logs ci-dessus."; }
trap on_error ERR

# Immediate purge (nvm compatibility)
unset PREFIX NPM_CONFIG_PREFIX 2>/dev/null || true
export -n PREFIX NPM_CONFIG_PREFIX 2>/dev/null || true

banner "INSTALLATEUR • NEOMNIA ACSS"

# ------------------ Root/Sudo ------------------
if [[ $EUID -ne 0 ]]; then
  if command -v sudo >/dev/null 2>&1; then SUDO="sudo"; else log "Exécutez en root ou installez sudo."; exit 1; fi
else SUDO=""; fi

# ------------------ Project ------------------
read -rp "${LOG_TAG} Nom du projet (ex: mon-app): " RAW_NAME
[[ -z "${RAW_NAME// }" ]] && { log "Nom de projet vide."; exit 1; }

# CRITICAL: Convert to lowercase and sanitize
PROJECT_NAME="$(echo "$RAW_NAME" | tr '[:upper:]' '[:lower:]' | sed -E 's/[[:space:]]+/-/g; s/[^a-z0-9-]//g; s/-+/-/g; s/^-|-$//g')"
[[ -z "$PROJECT_NAME" ]] && { log "Nom de projet invalide après normalisation."; exit 1; }

# Validate project name (npm compatible)
if ! echo "$PROJECT_NAME" | grep -qE '^[a-z0-9][a-z0-9-]*$'; then
  log "Nom de projet invalide pour npm (doit commencer par a-z0-9, contenir uniquement a-z0-9-)."; 
  exit 1; 
fi

PROJECT_DIR="/opt/${PROJECT_NAME}"
GROUP_NAME="${PROJECT_NAME}"

log "Projet normalisé: ${PROJECT_NAME}"

# ------------------ Target user to add to group ------------------
CANDIDATES=()
[[ -n "${SUDO_USER-}" ]] && CANDIDATES+=("${SUDO_USER}")
LOGNAME_CMD="$(logname 2>/dev/null || true)"; [[ -n "$LOGNAME_CMD" ]] && CANDIDATES+=("$LOGNAME_CMD")
CANDIDATES+=("$(id -un)")
TARGET_USER=""
for u in "${CANDIDATES[@]}"; do
  if [[ -n "$u" ]] && id "$u" >/dev/null 2>&1; then TARGET_USER="$u"; break; fi
done

# ------------------ Helpers ------------------
ver_ge() { printf '%s\n%s\n' "$1" "$2" | sort -V | head -n1 | grep -qx "$2"; }

# nvm in CURRENT SHELL
ensure_nvm() {
  unset PREFIX NPM_CONFIG_PREFIX || true
  local nvm_sh
  nvm_sh="${NVM_DIR:-$HOME/.nvm}/nvm.sh"
  if [[ -s "$nvm_sh" ]]; then
    # shellcheck source=/dev/null
    . "$nvm_sh"
  elif command -v nvm >/dev/null 2>&1; then
    :
  else
    log "Installation de nvm…"
    run_cmd "curl -fsSL https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash"
    nvm_sh="${NVM_DIR:-$HOME/.nvm}/nvm.sh"
    # shellcheck source=/dev/null
    . "$nvm_sh"
  fi
}

run_nvm_cmd() {
  local cmd="$*"
  log "→ (nvm) $cmd"
  set +e
  unset PREFIX NPM_CONFIG_PREFIX || true
  eval "$cmd" 2>&1 | while IFS= read -r l; do printf "%s %s\n" "${LOG_TAG}" "$l"; done
  local s=${PIPESTATUS[0]}
  set -e
  return $s
}

# ------------------ Node menu ------------------
banner "NODE • Sélection de version"
echo "${LOG_TAG} 1) LTS (auto via nvm)  [recommandé]"
echo "${LOG_TAG} 2) 22.x (courant)"
echo "${LOG_TAG} 3) 20.x (maintenance)"
echo "${LOG_TAG} 4) Custom (ex: 22.10.0)"
echo "${LOG_TAG} 5) Skip (utiliser Node déjà installé, ≥ 20.9)"
read -rp "${LOG_TAG} Votre choix [1]: " NODE_MENU
NODE_MENU="${NODE_MENU:-1}"

NODE_SELECTED=""
case "$NODE_MENU" in
  1) NODE_SELECTED="lts/*" ;;
  2) NODE_SELECTED="22" ;;
  3) NODE_SELECTED="20" ;;
  4) read -rp "${LOG_TAG} Version exacte (ex: 22.10.0): " NODE_SELECTED; [[ -z "${NODE_SELECTED// }" ]] && { log "Version vide."; exit 1; } ;;
  5) NODE_SELECTED="SKIP" ;;
  *) log "Choix invalide."; exit 1 ;;
esac

if [[ "$NODE_SELECTED" == "SKIP" ]]; then
  command -v node >/dev/null 2>&1 || { log "Node absent; impossible de Skip."; exit 1; }
  NODE_VER="$(node -v | sed 's/^v//')"
  ver_ge "$NODE_VER" "20.9.0" || { log "Node ${NODE_VER} < 20.9. Choisissez 1/2/3/4."; exit 1; }
  log "Node actif (skip): v${NODE_VER}"
else
  ensure_nvm
  run_nvm_cmd "nvm install '${NODE_SELECTED}'"
  run_nvm_cmd "nvm alias default '${NODE_SELECTED}'"
  # shellcheck source=/dev/null
  . "${NVM_DIR:-$HOME/.nvm}/nvm.sh"
  unset PREFIX NPM_CONFIG_PREFIX || true
  nvm use --silent default >/dev/null
  NODE_VER="$(node -v | sed 's/^v//')"
  log "Node actif: v${NODE_VER}"
fi

command -v npx >/dev/null 2>&1 || { log "npx introuvable (npm)."; exit 1; }

# ------------------ Next version ------------------
banner "NEXT • Sélection"
echo "${LOG_TAG} 1) latest (défaut)"
echo "${LOG_TAG} 2) Custom (ex: 16.1.3)"
read -rp "${LOG_TAG} Votre choix [1]: " NEXT_MENU
NEXT_MENU="${NEXT_MENU:-1}"
NEXT_CHOICE="latest"
if [[ "$NEXT_MENU" == "2" ]]; then
  read -rp "${LOG_TAG} Version Next (ex: 16.1.3): " NEXT_CHOICE
  [[ -z "${NEXT_CHOICE// }" ]] && { log "Version Next vide."; exit 1; }
fi

# ------------------ Group (before move) ------------------
banner "PRÉPARATION • ${PROJECT_NAME}"
if getent group "${GROUP_NAME}" >/dev/null 2>&1; then
  log "Groupe '${GROUP_NAME}' déjà existant."
else
  run_cmd "${SUDO} groupadd '${GROUP_NAME}'"
fi

# Add user to group
if [[ -n "$TARGET_USER" ]]; then
  if id -nG "$TARGET_USER" | tr ' ' '\n' | grep -qx "${GROUP_NAME}"; then
    log "Utilisateur '${TARGET_USER}' déjà membre du groupe '${GROUP_NAME}'."
  else
    run_cmd "${SUDO} usermod -aG '${GROUP_NAME}' '${TARGET_USER}'"
    log "Utilisateur '${TARGET_USER}' ajouté au groupe '${GROUP_NAME}' (⚠️ déconnexion/reconnexion requise)."
  fi
else
  log "Aucun utilisateur cible détecté pour ajout au groupe."
fi

[[ -e "${PROJECT_DIR}" ]] && { log "Le chemin ${PROJECT_DIR} existe déjà. Abandon."; exit 1; }

# ------------------ Scaffold in STAGING (/tmp, 100% lowercase name) ------------------
banner "CRÉATION • Next.js scaffold (staging)"

# CRITICAL FIX: Generate lowercase-only random suffix
RAND_SUFFIX="$(cat /dev/urandom | tr -dc 'a-z0-9' | fold -w 6 | head -n 1)"

# Ensure staging dir name is 100% lowercase and npm-compatible
STAGE_DIR="/tmp/${PROJECT_NAME}-${RAND_SUFFIX}"

log "Dossier staging : ${STAGE_DIR}"

# Verify staging dir name is lowercase
if ! echo "$STAGE_DIR" | grep -qE '^[a-z0-9/_-]+$'; then
  log "ERREUR: Le nom du dossier staging contient des caractères invalides: ${STAGE_DIR}"
  exit 1
fi

run_cmd "mkdir -p '${STAGE_DIR}'"

# Create Next.js app with explicit project name (lowercase)
CREATE_CMD="npx --yes create-next-app@${NEXT_CHOICE} '${STAGE_DIR}' --ts --app --tailwind --eslint --turbopack --use-npm --no-git"
run_cmd "${CREATE_CMD}"

# Verify package.json has correct name
if [[ -f "${STAGE_DIR}/package.json" ]]; then
  log "Vérification du package.json..."
  # Update package.json name to ensure it's lowercase
  run_cmd "cd '${STAGE_DIR}' && npm pkg set name='${PROJECT_NAME}'"
fi

# Pin Next if custom (in staging)
if [[ "${NEXT_CHOICE}" != "latest" ]]; then
  banner "PIN • next@${NEXT_CHOICE}"
  run_cmd "cd '${STAGE_DIR}' && npm i -E next@'${NEXT_CHOICE}'"
fi

# ------------------ Move to /opt then set rights ------------------
banner "DÉPLOIEMENT • /opt/${PROJECT_NAME}"
run_cmd "${SUDO} mv '${STAGE_DIR}' '${PROJECT_DIR}'"
run_cmd "${SUDO} chown -R root:'${GROUP_NAME}' '${PROJECT_DIR}'"
run_cmd "${SUDO} chmod 2775 '${PROJECT_DIR}'"               # setgid on root folder
run_cmd "${SUDO} chmod -R g+rwX '${PROJECT_DIR}'"           # group rights
run_cmd "${SUDO} find '${PROJECT_DIR}' -type d -exec chmod g+s {} +"  # setgid everywhere

# ACL (durable defaults)
if command -v setfacl >/dev/null 2>&1; then
  run_cmd "${SUDO} setfacl -R -m g:${GROUP_NAME}:rwX '${PROJECT_DIR}'"
  run_cmd "${SUDO} setfacl -dR -m g:${GROUP_NAME}:rwX '${PROJECT_DIR}'"
else
  log "setfacl indisponible; chmod+setgid appliqués."
fi

# .nvmrc if Node non-skip
if [[ "${NODE_SELECTED}" != "SKIP" ]]; then
  printf '%s\n' "${NODE_VER}" | ${SUDO} tee "${PROJECT_DIR}/.nvmrc" >/dev/null
fi

# ------------------ Summary ------------------
banner "RÉCAP • NEOMNIA ACSS"
log "Projet      : ${PROJECT_NAME}"
log "Dossier     : ${PROJECT_DIR}"
log "Groupe      : ${GROUP_NAME}"
log "Utilisateur : ${TARGET_USER:-N/A} (membre du groupe)"
log "Node        : v${NODE_VER}"
log "Next        : ${NEXT_CHOICE}"
log "Dev         : cd '${PROJECT_DIR}' && npm run dev"
log "Build/Start : cd '${PROJECT_DIR}' && npm run build && npm run start -- -p 3000"
log "⚠️  Déconnexion/reconnexion nécessaire pour l'ajout au groupe."

banner "TERMINÉ • NEOMNIA ACSS"
exit 0
